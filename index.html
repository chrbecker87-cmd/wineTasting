<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nils & Chris – Grand Cru Classé Tasting</title>
<style>
  :root{
    --bg:#fafafa; --txt:#111; --muted:#6b7280; --ring:#e5e7eb;
    --card:#ffffff; --card-green:#ecfdf5; --ring-green:#a7f3d0;
    --rose-bg:#fff1f2; --rose:#9f1239; --amber:#b45309; --emerald:#065f46;
  }
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  body{margin:0;background:var(--bg);color:var(--txt);}
  .container{max-width:1120px;margin:0 auto;padding:24px;}
  header{background:linear-gradient(#f4f4f5, #fff1f2 35%, #fafafa);}
  h1{margin:0;font-weight:600}
  .muted{color:var(--muted)}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:#111;transform-origin:left}
  .controls{display:grid;grid-template-columns:1fr 240px 220px;gap:12px;margin:20px 0}
  @media (max-width:900px){.controls{grid-template-columns:1fr}}
  .input, .select{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:12px;background:#fff}
  .switch{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
  .card{border:1px solid var(--ring);border-radius:16px;padding:14px;background:var(--card);transition:.15s box-shadow,.15s transform;min-height:240px;}
  .card:hover{box-shadow:0 4px 18px rgba(0,0,0,.06);transform:translateY(-1px)}
  .card.tasted{background:var(--card-green);border-color:var(--ring-green)}
  .title{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
  .title h3{margin:6px 0 2px 0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
  .badge{white-space:nowrap;flex-shrink:0;background:var(--rose-bg);color:var(--rose);border:1px solid #fecdd3;border-radius:999px;padding:2px 8px;font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .row label{align-self:center;font-size:14px}
  .score{display:flex;align-items:center;gap:8px}
  .score input{width:100%;padding:8px 10px;border:1px solid var(--ring);border-radius:10px}
  .status{display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:14px;gap:8px;flex-wrap:wrap}
  .green{color:var(--emerald);font-weight:500}
  .amber{color:var(--amber);font-weight:600}
  .footer-quote{margin-top:28px;padding:20px;border:1px solid var(--ring);border-radius:16px;background:#fff}
  .small{font-size:12px}
</style>
</head>
<body>

<header>
  <div class="container" style="text-align:center;padding:28px 16px">
    <h1 style="font-size:28px">Nils & Chris – Grand Cru Classé Tasting</h1>
    <div class="muted">Eine Lebensaufgabe: jeden Grand Cru Classé einmal gemeinsam verkosten.</div>
    <div style="max-width:560px;margin:16px auto 0">
      <div class="progress"><div id="progressBar" style="width:0%"></div></div>
      <div id="progressText" class="muted small" style="margin-top:6px">Fortschritt: 0/0 (0%)</div>
    </div>
  </div>
</header>

<section class="container">
  <div class="controls">
    <input id="search" class="input" placeholder="Suche nach Château, Herkunftsgebiet, Rebsorten oder Jahrgang…" />
    <select id="klass" class="select">
      <option>Alle</option><option>1er Cru</option><option>2e Cru</option>
      <option>3e Cru</option><option>4e Cru</option><option>5e Cru</option>
    </select>
    <label class="switch"><input type="checkbox" id="onlyTasted" /> Nur verkostete zeigen</label>
  </div>

  <div id="grid" class="grid"></div>

  <div id="empty" class="muted" style="text-align:center;display:none;margin:40px 0">
    Keine Einträge gefunden.
  </div>

  <div class="footer-quote" style="text-align:center">
    <em>„Wuff Wuff“</em>
    <div class="muted" style="margin-top:6px">Nils Trabold</div>
  </div>
</section>

<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, setDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgqvI3nx97gtWO79EMODiHeGuOCVoQ2S0",
    authDomain: "grandcru-20020.firebaseapp.com",
    projectId: "grandcru-20020",
    storageBucket: "grandcru-20020.appspot.com",
    messagingSenderId: "618883189419",
    appId: "1:618883189419:web:dbe8bd2b192e8f987e05ee"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Helpers
  const hasValidDate = v => v && (/^\d{4}-\d{2}-\d{2}$/.test(v) || /^\d{2}\.\d{2}\.\d{4}$/.test(v));
  const formatDateTTMMJJJJ = v => {
    if (!v) return "";
    const iso = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
    if (iso) return `${iso[3]}.${iso[2]}.${iso[1]}`;
    const de = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(v);
    if (de) return `${de[1]}.${de[2]}.${de[3]}`;
    const d = new Date(v);
    if (isNaN(d)) return "";
    return `${String(d.getDate()).padStart(2,"0")}.${String(d.getMonth()+1).padStart(2,"0")}.${d.getFullYear()}`;
  };
  const clampScore = v => {
    if (v==="" || v==null) return "";
    let n = parseInt(v,10); if (isNaN(n)) return "";
    return String(Math.max(0, Math.min(100, n)));
  };
  const clampYear = v => {
    if (v==="" || v==null) return "";
    let n = parseInt(v,10); if (isNaN(n)) return "";
    return String(Math.max(1900, Math.min(2100, n)));
  };
  const averageScore = (a,b) => {
    const na = a===""||a==null ? NaN : parseInt(a,10);
    const nb = b===""||b==null ? NaN : parseInt(b,10);
    if (isNaN(na) && isNaN(nb)) return "";
    if (isNaN(na)) return String(nb);
    if (isNaN(nb)) return String(na);
    return String(Math.round((na+nb)/2));
  };

  // Basisdaten (statische Voll-Liste)
  const BASE_DATA = [
    // 1er (5)
    { château:"Château Lafite Rothschild", klassifikation:"1er Cru", herkunftsgebiet:"Pauillac", rebsorten:"91% Cabernet Sauvignon, 8% Merlot, 1% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Latour", klassifikation:"1er Cru", herkunftsgebiet:"Pauillac", rebsorten:"90% Cabernet Sauvignon, 9% Merlot, 1% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Margaux", klassifikation:"1er Cru", herkunftsgebiet:"Margaux", rebsorten:"89% Cabernet Sauvignon, 8% Merlot, 3% Cabernet Franc/Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Haut-Brion", klassifikation:"1er Cru", herkunftsgebiet:"Pessac-Léognan", rebsorten:"55% Merlot, 37% Cabernet Sauvignon, 8% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Mouton Rothschild", klassifikation:"1er Cru", herkunftsgebiet:"Pauillac", rebsorten:"80% Cabernet Sauvignon, 16% Merlot, 4% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },

    // 2e
    { château:"Château Léoville-Las Cases", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"80% Cabernet Sauvignon, 11% Cabernet Franc, 9% Merlot", verkostetAm:"19.09.2025", scoreNils:"100", scoreChris:"" },
    { château:"Château Léoville-Poyferré", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"65% Cabernet Sauvignon, 25% Merlot, 8% Petit Verdot, 2% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Léoville-Barton", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"83% Cabernet Sauvignon, 15% Merlot, 2% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Gruaud-Larose", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"60% Cabernet Sauvignon, 30% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Ducru-Beaucaillou", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"90% Cabernet Sauvignon, 10% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Rauzan-Ségla", klassifikation:"2e Cru", herkunftsgebiet:"Margaux", rebsorten:"62% Cabernet Sauvignon, 35% Merlot, 3% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Rauzan-Gassies", klassifikation:"2e Cru", herkunftsgebiet:"Margaux", rebsorten:"65% Cabernet Sauvignon, 28% Merlot, 7% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Durfort-Vivens", klassifikation:"2e Cru", herkunftsgebiet:"Margaux", rebsorten:"70% Cabernet Sauvignon, 24% Merlot, 6% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Lascombes", klassifikation:"2e Cru", herkunftsgebiet:"Margaux", rebsorten:"50% Cabernet Sauvignon, 45% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Brane-Cantenac", klassifikation:"2e Cru", herkunftsgebiet:"Margaux", rebsorten:"55% Cabernet Sauvignon, 40% Merlot, 5% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Pichon Baron", klassifikation:"2e Cru", herkunftsgebiet:"Pauillac", rebsorten:"80% Cabernet Sauvignon, 20% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Pichon Comtesse de Lalande", klassifikation:"2e Cru", herkunftsgebiet:"Pauillac", rebsorten:"75% Cabernet Sauvignon, 25% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Cos d’Estournel", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Estèphe", rebsorten:"76% Cabernet Sauvignon, 23% Merlot, 1% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Montrose", klassifikation:"2e Cru", herkunftsgebiet:"Saint-Estèphe", rebsorten:"68% Cabernet Sauvignon, 25% Merlot, 7% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },

    // 3e (14)
    { château:"Château Kirwan", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"45% Cabernet Sauvignon, 30% Merlot, 25% Cabernet Franc/Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château d’Issan", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 40% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Giscours", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"65% Cabernet Sauvignon, 30% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Malescot St-Exupéry", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"50% Cabernet Sauvignon, 35% Merlot, 10% Cabernet Franc, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Cantenac-Brown", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"65% Cabernet Sauvignon, 30% Merlot, 5% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Boyd-Cantenac", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"70% Cabernet Sauvignon, 25% Merlot, 5% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Palmer", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"47% Cabernet Sauvignon, 47% Merlot, 6% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Desmirail", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 35% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Ferrière", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"70% Cabernet Sauvignon, 25% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Marquis d’Alesme Becker", klassifikation:"3e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 30% Merlot, 10% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Lagrange", klassifikation:"3e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"70% Cabernet Sauvignon, 25% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Langoa Barton", klassifikation:"3e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"57% Cabernet Sauvignon, 34% Merlot, 9% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Calon-Ségur", klassifikation:"3e Cru", herkunftsgebiet:"Saint-Estèphe", rebsorten:"60% Cabernet Sauvignon, 30% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château La Lagune", klassifikation:"3e Cru", herkunftsgebiet:"Haut-Médoc", rebsorten:"60% Cabernet Sauvignon, 30% Merlot, 10% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },

    // 4e (10)
    { château:"Château Saint-Pierre", klassifikation:"4e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"75% Cabernet Sauvignon, 15% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Talbot", klassifikation:"4e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"66% Cabernet Sauvignon, 26% Merlot, 8% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Branaire-Ducru", klassifikation:"4e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"70% Cabernet Sauvignon, 22% Merlot, 5% Cabernet Franc, 3% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Beychevelle", klassifikation:"4e Cru", herkunftsgebiet:"Saint-Julien", rebsorten:"52% Cabernet Sauvignon, 40% Merlot, 8% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Marquis de Terme", klassifikation:"4e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 35% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Pouget", klassifikation:"4e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 35% Merlot, 5% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Prieuré-Lichine", klassifikation:"4e Cru", herkunftsgebiet:"Margaux", rebsorten:"70% Cabernet Sauvignon, 25% Merlot, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Duhart-Milon", klassifikation:"4e Cru", herkunftsgebiet:"Pauillac", rebsorten:"67% Cabernet Sauvignon, 33% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Lafon-Rochet", klassifikation:"4e Cru", herkunftsgebiet:"Saint-Estèphe", rebsorten:"54% Cabernet Sauvignon, 40% Merlot, 4% Cabernet Franc, 2% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château La Tour Carnet", klassifikation:"4e Cru", herkunftsgebiet:"Haut-Médoc", rebsorten:"60% Merlot, 37% Cabernet Sauvignon, 3% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },

    // 5e (18)
    { château:"Château Pontet-Canet", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"62% Cabernet Sauvignon, 32% Merlot, 4% Cabernet Franc, 2% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Batailley", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"70% Cabernet Sauvignon, 25% Merlot, 3% Cabernet Franc, 2% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Haut-Batailley", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"65% Cabernet Sauvignon, 25% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Grand-Puy-Lacoste", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"80% Cabernet Sauvignon, 20% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Grand-Puy-Ducasse", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"60% Cabernet Sauvignon, 35% Merlot, 5% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Lynch-Bages", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"75% Cabernet Sauvignon, 15% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Lynch-Moussas", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"70% Cabernet Sauvignon, 27% Merlot, 3% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château d’Armailhac", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"60% Cabernet Sauvignon, 29% Merlot, 9% Cabernet Franc, 2% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Pédesclaux", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"65% Cabernet Sauvignon, 25% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Clerc-Milon", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"50% Cabernet Sauvignon, 35% Merlot, 10% Cabernet Franc, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Croizet-Bages", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"70% Cabernet Sauvignon, 30% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Haut-Bages Libéral", klassifikation:"5e Cru", herkunftsgebiet:"Pauillac", rebsorten:"70% Cabernet Sauvignon, 30% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Dauzac", klassifikation:"5e Cru", herkunftsgebiet:"Margaux", rebsorten:"60% Cabernet Sauvignon, 40% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château du Tertre", klassifikation:"5e Cru", herkunftsgebiet:"Margaux", rebsorten:"43% Cabernet Sauvignon, 33% Merlot, 19% Cabernet Franc, 5% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Belgrave", klassifikation:"5e Cru", herkunftsgebiet:"Haut-Médoc", rebsorten:"50% Cabernet Sauvignon, 40% Merlot, 10% Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Camensac", klassifikation:"Haut-Médoc", herkunftsgebiet:"Haut-Médoc", rebsorten:"60% Cabernet Sauvignon, 40% Merlot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Cantemerle", klassifikation:"5e Cru", herkunftsgebiet:"Haut-Médoc", rebsorten:"60% Cabernet Sauvignon, 30% Merlot, 10% Cabernet Franc/Petit Verdot", verkostetAm:"", scoreNils:"", scoreChris:"" },
    { château:"Château Cos Labory", klassifikation:"5e Cru", herkunftsgebiet:"Saint-Estèphe", rebsorten:"55% Cabernet Sauvignon, 35% Merlot, 10% Cabernet Franc", verkostetAm:"", scoreNils:"", scoreChris:"" },
  ].map((w,i)=>({ ...w, jahrgang: w.jahrgang ?? "", _order:i }));

  // Firestore IO (mit merge)
  async function saveWineData(wine) {
    try {
      await setDoc(doc(db, "weine", wine.château), wine, { merge: true });
    } catch (e) {
      console.error("Speicherfehler:", e);
    }
  }

  // Live-Daten abonnieren und STABIL mit Basisdaten mergen
  function subscribeToWineData() {
    const ref = collection(db, "weine");
    onSnapshot(ref, (snapshot) => {
      const map = new Map();
      snapshot.forEach(docSnap => { map.set(docSnap.id, docSnap.data()); });

      // Merge: Basisliste bleibt vollständig; Firestore-Felder überschreiben Basis
      data = BASE_DATA.map(base => {
        const live = map.get(base.château);
        return {
          ...base,
          ...(live || {}),
          jahrgang: (live && live.jahrgang != null ? live.jahrgang : (base.jahrgang ?? "")),
          _order: (live && live._order != null ? live._order : base._order)
        };
      });

      render();
    }, (err) => {
      console.warn("Firestore-Live-Update fehlgeschlagen:", err);
      data = BASE_DATA;
      render();
    });
  }

  // DOM Refs
  const elGrid        = document.getElementById("grid");
  const elEmpty       = document.getElementById("empty");
  const elSearch      = document.getElementById("search");
  const elKlass       = document.getElementById("klass");
  const elOnlyTasted  = document.getElementById("onlyTasted");
  const elProgressBar = document.getElementById("progressBar");
  const elProgressTxt = document.getElementById("progressText");

  // State
  let data = [];

  function updateProgress(){
    const total = data.length || 1;
    const tasted = data.filter(w=>hasValidDate(w.verkostetAm)).length;
    const pct = Math.round((tasted/total)*100);
    elProgressBar.style.width = pct + "%";
    elProgressTxt.textContent = `Fortschritt: ${tasted}/${data.length} Weine (${pct}%)`;
  }

  function render(){
    const q = elSearch.value.trim().toLowerCase();
    const klass = elKlass.value;
    const onlyTasted = elOnlyTasted.checked;

    const filtered = data
      .filter(w => klass==="Alle" || w.klassifikation===klass)
      .filter(w => !onlyTasted || hasValidDate(w.verkostetAm))
      .filter(w => q ? (w.château+w.herkunftsgebiet+w.rebsorten+String(w.jahrgang||"")).toLowerCase().includes(q) : true)
      .slice().sort((a,b)=>(a._order??0)-(b._order??0));

    elGrid.innerHTML = "";
    elEmpty.style.display = filtered.length ? "none" : "block";

    filtered.forEach(w=>{
      const card = document.createElement("div");
      card.className = "card" + (hasValidDate(w.verkostetAm) ? " tasted" : "");

      const head = document.createElement("div"); head.className="title";
      const h3 = document.createElement("h3"); h3.textContent = w.château;
      const badge = document.createElement("div"); badge.className="badge"; badge.textContent=w.klassifikation;
      head.appendChild(h3); head.appendChild(badge);

      const loc = document.createElement("div"); loc.className="muted small"; loc.textContent=w.herkunftsgebiet;

      const grapes = document.createElement("div"); grapes.className="small";
      grapes.innerHTML = "<strong>Rebsorten:</strong> " + w.rebsorten;

      // Jahrgang
      const rowVintage = document.createElement("div"); rowVintage.className="row";
      const lblVintage = document.createElement("label"); lblVintage.textContent = "Jahrgang";
      const inputVintage = document.createElement("input");
      inputVintage.className = "input";
      inputVintage.type = "number";
      inputVintage.inputMode = "numeric";
      inputVintage.min = "1900";
      inputVintage.max = "2100";
      inputVintage.placeholder = "z. B. 2016";
      inputVintage.value = w.jahrgang || "";
      inputVintage.addEventListener("change", async (e) => {
        w.jahrgang = clampYear(e.target.value);
        e.target.value = w.jahrgang;
        await saveWineData(w);
      });
      inputVintage.addEventListener("blur", async (e) => {
        w.jahrgang = clampYear(e.target.value);
        e.target.value = w.jahrgang;
        await saveWineData(w);
      });
      rowVintage.appendChild(lblVintage); rowVintage.appendChild(inputVintage);

      // Datum
      const rowDate = document.createElement("div"); rowDate.className="row";
      const lblDate = document.createElement("label"); lblDate.textContent="Verkostet am";
      const inputDate = document.createElement("input"); inputDate.className="input"; inputDate.type="date";
      inputDate.value = /^\d{4}-\d{2}-\d{2}$/.test(w.verkostetAm||"") ? w.verkostetAm : "";
      inputDate.addEventListener("change", async (e)=>{
        w.verkostetAm = e.target.value || "";
        await saveWineData(w);
        // sanft nur Status/Progress aktualisieren
        updateStatus();
      });
      rowDate.appendChild(lblDate); rowDate.appendChild(inputDate);

      // Scores
      const rowScore = document.createElement("div"); rowScore.className="row";
      const s1 = document.createElement("div"); s1.className="score";
      const l1 = document.createElement("label"); l1.textContent="Nils"; l1.style.width="60px";
      const i1 = document.createElement("input"); i1.type="number"; i1.min="0"; i1.max="100"; i1.placeholder="0–100"; i1.value=w.scoreNils||"";
      i1.addEventListener("change", async (e)=>{ w.scoreNils=clampScore(e.target.value); e.target.value=w.scoreNils; await saveWineData(w); updateStatus(); });
      i1.addEventListener("blur",  async (e)=>{ w.scoreNils=clampScore(e.target.value); e.target.value=w.scoreNils; await saveWineData(w); updateStatus(); });

      const s2 = document.createElement("div"); s2.className="score";
      const l2 = document.createElement("label"); l2.textContent="Chris"; l2.style.width="60px";
      const i2 = document.createElement("input"); i2.type="number"; i2.min="0"; i2.max="100"; i2.placeholder="0–100"; i2.value=w.scoreChris||"";
      i2.addEventListener("change", async (e)=>{ w.scoreChris=clampScore(e.target.value); e.target.value=w.scoreChris; await saveWineData(w); updateStatus(); });
      i2.addEventListener("blur",  async (e)=>{ w.scoreChris=clampScore(e.target.value); e.target.value=w.scoreChris; await saveWineData(w); updateStatus(); });

      s1.appendChild(l1); s1.appendChild(i1);
      s2.appendChild(l2); s2.appendChild(i2);
      rowScore.appendChild(s1); rowScore.appendChild(s2);

      const status = document.createElement("div"); status.className="status";
      const left = document.createElement("div");
      const right = document.createElement("div"); right.className="amber";

      function updateStatus(){
        card.className = "card" + (hasValidDate(w.verkostetAm) ? " tasted" : "");
        left.className = hasValidDate(w.verkostetAm) ? "green" : "muted";
        left.textContent = hasValidDate(w.verkostetAm) ? "Verkostet am " + formatDateTTMMJJJJ(w.verkostetAm) : "Noch nicht verkostet";
        const avg = averageScore(w.scoreNils||"", w.scoreChris||"");
        right.textContent = (w.scoreNils||w.scoreChris) ? (avg ? "Ø "+avg+"/100" : (w.scoreNils||w.scoreChris)+"/100") : "";
        updateProgress();
      }
      updateStatus();

      status.appendChild(left); status.appendChild(right);

      // Karte zusammenbauen
      card.appendChild(head);
      card.appendChild(loc);
      card.appendChild(grapes);
      card.appendChild(rowVintage);
      card.appendChild(rowDate);
      card.appendChild(rowScore);
      card.appendChild(status);
      elGrid.appendChild(card);
    });

    updateProgress();
  }

  // Events
  elSearch.addEventListener("input", render);
  elKlass.addEventListener("change", render);
  elOnlyTasted.addEventListener("change", render);

  // Start
  subscribeToWineData();
</script>

</body>
</html>
